<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supra Dental Lab - Live Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --base-font-size: 14px;
            --primary-dark: #0f0f23;
            --secondary-dark: #16213e;
            --accent-blue: #0ea5e9;
            --accent-purple: #8b5cf6;
            --accent-emerald: #10b981;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --card-bg: rgba(30, 41, 59, 0.8);
            --card-border: rgba(148, 163, 184, 0.1);
            --surface-1: rgba(51, 65, 85, 0.6);
            --surface-2: rgba(71, 85, 105, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: var(--base-font-size);
            letter-spacing: -0.025em;
            position: relative;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(14, 165, 233, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.1) 1px, transparent 1px);
            background-size: 60px 60px, 80px 80px;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(10px, -10px) rotate(1deg); }
            66% { transform: translate(-5px, 5px) rotate(-1deg); }
        }

        .header {
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--card-border);
            padding: 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            height: 48px;
        }

        .header.hidden {
            transform: translateY(-100%);
        }

        body.header-hidden .monitor-container {
            height: 100vh;
            margin-top: 0;
        }

        /* Responsive design for different screen sizes */
        @media (max-width: 1400px) {
            .monitor-container {
                gap: 24px;
                padding: 24px;
            }
        }

        @media (max-width: 1200px) {
            .monitor-container {
                gap: 20px;
                padding: 20px;
            }
            
            .panel-header {
                padding: 20px 24px;
            }
        }

        /* Large screen optimizations */
        @media (min-width: 1920px) {
            .monitor-container {
                gap: 40px;
                padding: 40px;
            }
            
            .header {
                padding: 24px 48px;
            }
        }

        .monitor-container {
            height: calc(100vh - 48px);
            margin-top: 48px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.02em;
            position: relative;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--surface-1);
            border: 1px solid var(--card-border);
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(16px);
        }

        .control-group:hover {
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2);
            border-color: rgba(14, 165, 233, 0.4);
            transform: translateY(-2px);
        }

        .control-group label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
        }

        .control-group select, .control-group input {
            background: var(--surface-2);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            outline: none;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 50px;
        }

        .control-group select:focus, .control-group input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
            background: var(--surface-1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--surface-1);
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-emerald);
            animation: pulse 3s infinite;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            position: relative;
        }

        .status-dot::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            animation: ping 3s infinite;
        }

        .status-dot.offline {
            background: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
            animation: none;
        }

        .status-dot.offline::after {
            animation: none;
        }

        .monitor-container {
            display: grid;
            gap: 2px;
            background: var(--card-border);
            padding: 2px;
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .monitor-container.layout-6panel {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
        }

        .monitor-container.layout-3panel {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
        }

        .panel {
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            border: none;
            border-radius: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: none;
        }

        .panel:hover {
            transform: none;
            box-shadow: inset 0 0 0 1px rgba(14, 165, 233, 0.3);
        }

        .panel-header {
            background: var(--surface-1);
            padding: 12px 20px;
            font-size: calc(var(--base-font-size) + 2px);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            border-bottom: 1px solid var(--card-border);
        }

        .panel-title {
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        .count-badge {
            background: var(--accent-blue);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            min-width: 32px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .panel:nth-child(2) .count-badge {
            background: var(--accent-purple);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .panel:nth-child(3) .count-badge {
            background: var(--accent-emerald);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: transparent;
        }

        .scrollable-list {
            height: 100%;
            overflow-y: auto;
            padding: 0;
        }

        .scrollable-list::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .scrollable-list::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        .list-item {
            padding: 8px 16px;
            border-bottom: 1px solid var(--card-border);
            transition: all 0.2s ease;
            font-size: var(--base-font-size);
            line-height: 1.4;
            position: relative;
        }

        .list-item:hover {
            background: var(--surface-1);
            border-left: 3px solid var(--accent-blue);
            padding-left: 13px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item.today {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
            border-left: 3px solid #ef4444;
        }

        .list-item.tomorrow {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%);
            border-left: 3px solid #f59e0b;
        }

        .item-header {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 4px;
        }

        .item-info {
            display: contents;
        }

        .doctor-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: calc(var(--base-font-size) + 2px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.02em;
        }

        .patient-name {
            color: var(--text-secondary);
            font-size: calc(var(--base-font-size) + 1px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .item-time {
            font-size: var(--base-font-size);
            color: var(--text-muted);
            font-weight: 500;
            text-align: right;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            background: var(--surface-2);
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .stage-name {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Inter', sans-serif;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .status-waiting {
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: var(--text-primary);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
        }

        .status-active {
            background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
            color: var(--text-primary);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .loading, .no-data {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-muted);
            font-style: italic;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            position: relative;
        }

        .loading::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-muted);
            border-top: 2px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .day-group {
            background: var(--surface-1);
            padding: 8px 16px;
            border-bottom: 1px solid var(--card-border);
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(16px);
        }

        .appointment-item, .delivery-item {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 12px;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--card-border);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .appointment-item:hover, .delivery-item:hover {
            background: var(--surface-1);
            border-left: 3px solid var(--accent-blue);
            padding-left: 13px;
        }

        .appointment-info, .delivery-info {
            display: contents;
        }

        .appointment-doctor, .delivery-doctor {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.02em;
            font-size: calc(var(--base-font-size) + 1px);
        }

        .appointment-time {
            color: var(--text-muted);
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            font-size: 13px;
            background: var(--surface-2);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .delivery-schedule {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .appointment-creator, .delivery-creator {
            color: var(--text-muted);
            font-size: 12px;
            text-align: right;
            font-weight: 500;
        }

        @keyframes pulse {
            0% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.05);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
            }
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .list-item {
            animation: slideIn 0.3s ease;
        }

        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .status-bar.active {
            background: linear-gradient(90deg, transparent 0%, var(--accent-emerald) 20%, var(--accent-emerald) 80%, transparent 100%);
            background-size: 200% 100%;
            animation: subtleLoading 2.5s ease-in-out infinite;
            opacity: 0.9;
        }

        .status-bar.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes subtleLoading {
            0% { 
                background-position: -200% 0;
                opacity: 0.4;
            }
            50% { 
                background-position: 0% 0;
                opacity: 0.9;
            }
            100% { 
                background-position: 200% 0;
                opacity: 0.4;
            }
        }

        .mode-compact .list-item {
            padding: 6px 12px;
            font-size: 12px;
        }

        .mode-compact .panel-header {
            padding: 8px 16px;
            font-size: calc(var(--base-font-size) + 1px);
        }

        .mode-compact .item-header {
            gap: 8px;
            margin-bottom: 2px;
        }

        .mode-compact .status-info {
            margin-top: 2px;
        }

        .mode-compact .day-group {
            padding: 6px 12px;
        }

        .mode-compact .appointment-item, .mode-compact .delivery-item {
            padding: 6px 12px;
        }

        .hidden {
            display: none !important;
        }

        /* Enhanced glass morphism for modern browsers */
        @supports (backdrop-filter: blur(24px)) {
            .panel {
                background: var(--card-bg);
                backdrop-filter: blur(24px) saturate(1.2);
            }
            
            .header {
                background: var(--card-bg);
                backdrop-filter: blur(32px) saturate(1.1);
            }
            
            .control-group {
                backdrop-filter: blur(20px);
            }
        }

        /* Performance optimizations */
        .panel, .list-item, .control-group {
            will-change: transform;
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <line x1="8" y1="21" x2="16" y2="21" stroke="currentColor" stroke-width="2"/>
                <line x1="12" y1="17" x2="12" y2="21" stroke="currentColor" stroke-width="2"/>
            </svg>
            SUPRA DENTAL LAB - LIVE MONITOR
        </h1>
        <div class="header-controls">
            <div class="control-group">
                <label>MODE:</label>
                <select id="display-mode">
                    <option value="standard" selected>STANDARD</option>
                    <option value="compact">COMPACT</option>
                </select>
            </div>
            <div class="control-group">
                <label>FONT:</label>
                <select id="font-size">
                    <option value="10px">XS</option>
                    <option value="11px">SM</option>
                    <option value="12px" selected>MD</option>
                    <option value="13px">LG</option>
                    <option value="14px">XL</option>
                </select>
            </div>
            <div class="control-group">
                <label>REFRESH:</label>
                <input type="text" id="refresh-control" value="5" style="width: 30px; -webkit-appearance: none; -moz-appearance: textfield;"> SEC
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">LIVE</span>
            </div>
        </div>
    </div>

    <div class="monitor-container layout-3panel" id="monitor-container">
        <!-- Appointments Panel -->
        <div class="panel" id="appointments-panel">
            <div class="panel-header">
                <span class="panel-title">APPOINTMENTS</span>
                <div class="count-badge" id="appointments-count">0</div>
            </div>
            <div class="panel-content">
                <div class="scrollable-list" id="appointments-list">
                    <div class="loading">LOADING APPOINTMENTS...</div>
                </div>
            </div>
            <div class="status-bar" id="appointments-status"></div>
        </div>

        <!-- Orders Panel -->
        <div class="panel" id="orders-panel">
            <div class="panel-header">
                <span class="panel-title">ORDERS (Design • Milling • Furnace)</span>
                <div class="count-badge" id="orders-count">0</div>
            </div>
            <div class="panel-content">
                <div class="scrollable-list" id="orders-list">
                    <div class="loading">LOADING ORDERS...</div>
                </div>
            </div>
            <div class="status-bar" id="orders-status"></div>
        </div>

        <!-- Deliveries Panel -->
        <div class="panel" id="deliveries-panel">
            <div class="panel-header">
                <span class="panel-title">DELIVERIES</span>
                <div class="count-badge" id="deliveries-count">0</div>
            </div>
            <div class="panel-content">
                <div class="scrollable-list" id="deliveries-list">
                    <div class="loading">LOADING DELIVERIES...</div>
                </div>
            </div>
            <div class="status-bar" id="deliveries-status"></div>
        </div>

    </div>

    <script>
        class SupraMonitor {
            constructor() {
                this.refreshInterval = 5000;
                this.layout = '3panel';
                this.displayMode = 'standard';
                this.isOnline = true;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadAllData();
                this.startAutoRefresh();
                this.startStatusCheck();
            }

            setupEventListeners() {
                document.getElementById('display-mode').addEventListener('change', (e) => {
                    this.displayMode = e.target.value;
                    this.updateDisplayMode();
                });

                document.getElementById('font-size').addEventListener('change', (e) => {
                    const fontSize = e.target.value;
                    document.documentElement.style.setProperty('--base-font-size', fontSize);
                    document.body.style.fontSize = fontSize;
                });

                document.getElementById('refresh-control').addEventListener('change', (e) => {
                    this.refreshInterval = parseInt(e.target.value) * 1000;
                    this.restartAutoRefresh();
                });
            }

            async fetchWithFallback(type) {
                const endpoints = [
                    `/api/monitor?type=${type}`,
                    `monitor_api.php?type=${type}`
                ];

                for (let endpoint of endpoints) {
                    try {
                        console.log(`Trying endpoint: ${endpoint}`);
                        const response = await fetch(endpoint, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log(`Response status for ${endpoint}:`, response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.warn(`Endpoint ${endpoint} failed:`, response.status, errorText);
                            continue; // Try next endpoint
                        }
                        
                        const data = await response.json();
                        console.log(`Success with ${endpoint}:`, data);
                        
                        if (data.error) {
                            console.warn(`Endpoint ${endpoint} returned error:`, data.error);
                            continue; // Try next endpoint
                        }
                        
                        return data; // Success!
                        
                    } catch (error) {
                        console.warn(`Endpoint ${endpoint} threw error:`, error.message);
                        continue; // Try next endpoint
                    }
                }
                
                // If all endpoints failed, throw an error
                throw new Error(`All API endpoints failed for type: ${type}`);
            }


            updateDisplayMode() {
                document.body.className = this.displayMode !== 'standard' ? `mode-${this.displayMode}` : '';
            }

            async loadAllData() {
                await Promise.all([
                    this.loadAppointments(),
                    this.loadOrders(),
                    this.loadDeliveries()
                ]);
            }

            async loadAppointments() {
                this.showLoading('appointments');
                try {
                    console.log('Fetching appointments...');
                    let data = await this.fetchWithFallback('appointments');
                    console.log('Appointments data:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.renderAppointments(data);
                    this.updateStatus('appointments', true);
                } catch (error) {
                    console.error('Appointments error:', error);
                    this.renderError('appointments', 'FAILED TO LOAD APPOINTMENTS: ' + error.message);
                    this.updateStatus('appointments', false);
                } finally {
                    this.hideLoading('appointments');
                }
            }

            async loadOrders() {
                this.showLoading('orders');
                try {
                    console.log('Fetching orders...');
                    let data = await this.fetchWithFallback('orders');
                    console.log('Orders data:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.renderOrders(data);
                    this.updateStatus('orders', true);
                } catch (error) {
                    console.error('Orders error:', error);
                    this.renderError('orders', 'FAILED TO LOAD ORDERS: ' + error.message);
                    this.updateStatus('orders', false);
                } finally {
                    this.hideLoading('orders');
                }
            }

            async loadDeliveries() {
                this.showLoading('deliveries');
                try {
                    console.log('Fetching deliveries...');
                    let data = await this.fetchWithFallback('deliveries');
                    console.log('Deliveries data:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.renderDeliveries(data);
                    this.updateStatus('deliveries', true);
                } catch (error) {
                    console.error('Deliveries error:', error);
                    this.renderError('deliveries', 'FAILED TO LOAD DELIVERIES: ' + error.message);
                    this.updateStatus('deliveries', false);
                } finally {
                    this.hideLoading('deliveries');
                }
            }

            renderAppointments(appointments) {
                const container = document.getElementById('appointments-list');
                let html = '';
                let totalCount = 0;

                if (!appointments || Object.keys(appointments).length === 0) {
                    html = '<div class="no-data">NO APPOINTMENTS TODAY</div>';
                } else {
                    // Handle grouped appointments by date
                    for (const [date, dateAppointments] of Object.entries(appointments)) {
                        const dateObj = new Date(date);
                        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        html += `<div class="day-group">${dayName}, ${formattedDate}</div>`;
                        
                        dateAppointments.forEach(apt => {
                            totalCount++;
                            html += `
                                <div class="appointment-item list-item">
                                    <div class="item-header">
                                        <div class="doctor-name">${apt.doctor_name}</div>
                                        <div class="item-time">${apt.formatted_time || apt.time}</div>
                                    </div>
                                    <div class="patient-name">${apt.description || 'Appointment'}</div>
                                    <div class="status-info">
                                        <div class="stage-name">Created by: ${apt.created_by_lastname || 'N/A'}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }

                container.innerHTML = html;
                document.getElementById('appointments-count').textContent = totalCount;
            }

            renderOrders(orders) {
                const container = document.getElementById('orders-list');
                let html = '';

                if (!orders || orders.length === 0) {
                    html = '<div class="no-data">NO ACTIVE CASES</div>';
                } else {
                    orders.forEach(order => {
                        const urgencyClass = order.delivery_urgency || '';
                        const statusClass = order.status_type === 'waiting' ? 'status-waiting' : 'status-active';
                        const deliveryDisplay = order.formatted_delivery_date || new Date(order.deliver_date).toLocaleDateString();
                        
                        html += `
                            <div class="list-item ${urgencyClass}">
                                <div class="item-header">
                                    <div class="doctor-name">${order.doctor_name}</div>
                                    <div class="item-time">${deliveryDisplay}</div>
                                </div>
                                <div class="patient-name">${order.patient_name} (#${order.order_id})</div>
                                <div class="status-info">
                                    <div class="stage-name">${order.stage_name}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${order.status_display}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
                document.getElementById('orders-count').textContent = orders?.length || 0;
            }

            renderDeliveries(deliveries) {
                const container = document.getElementById('deliveries-list');
                let html = '';

                if (!deliveries || deliveries.length === 0) {
                    html = '<div class="no-data">NO SCHEDULED DELIVERIES</div>';
                } else {
                    deliveries.forEach(delivery => {
                        const urgencyClass = delivery.delivery_urgency || '';
                        const statusClass = delivery.status_type === 'waiting' ? 'status-waiting' : 'status-active';
                        const deliveryDisplay = delivery.formatted_delivery_date || new Date(delivery.deliver_date).toLocaleDateString();
                        const timeDisplay = delivery.formatted_delivery_time || delivery.delivery_time;
                        
                        html += `
                            <div class="delivery-item list-item ${urgencyClass}">
                                <div class="item-header">
                                    <div class="doctor-name">${delivery.doctor_name}</div>
                                    <div class="item-time">${deliveryDisplay} ${timeDisplay}</div>
                                </div>
                                <div class="patient-name">${delivery.patient_name} (#${delivery.order_id})</div>
                                <div class="status-info">
                                    <div class="stage-name">${delivery.day_name || 'Delivery'}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${delivery.status_display || 'READY'}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
                document.getElementById('deliveries-count').textContent = deliveries?.length || 0;
            }

            renderError(section, message) {
                const container = document.getElementById(`${section}-list`);
                container.innerHTML = `<div class="no-data">${message}</div>`;
                document.getElementById(`${section}-count`).textContent = '!';
            }

            showLoading(section) {
                document.getElementById(`${section}-status`).classList.add('active');
            }

            hideLoading(section) {
                document.getElementById(`${section}-status`).classList.remove('active');
            }

            updateStatus(section, success) {
                const statusBar = document.getElementById(`${section}-status`);
                if (success) {
                    statusBar.style.background = 'rgba(35, 134, 54, 0.4)';
                    statusBar.style.height = '2px';
                    setTimeout(() => {
                        statusBar.style.background = '#161b22';
                        statusBar.style.height = '1px';
                    }, Math.min(this.refreshInterval / 10, 800));
                } else {
                    statusBar.style.background = 'rgba(218, 54, 51, 0.6)';
                    statusBar.style.height = '2px';
                }
            }

            async startStatusCheck() {
                setInterval(async () => {
                    try {
                        const data = await this.fetchWithFallback('status');
                        this.updateSystemStatus(true);
                    } catch (error) {
                        this.updateSystemStatus(false);
                    }
                }, 10000); // Check every 10 seconds
            }

            updateSystemStatus(isOnline) {
                this.isOnline = isOnline;
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                if (isOnline) {
                    statusDot.classList.remove('offline');
                    statusText.textContent = 'LIVE';
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = 'OFFLINE';
                }
            }

            startAutoRefresh() {
                clearInterval(this.refreshTimer);
                this.refreshTimer = setInterval(() => {
                    if (this.isOnline) {
                        this.loadAllData();
                    }
                }, this.refreshInterval);
            }

            restartAutoRefresh() {
                this.startAutoRefresh();
            }
        }

        // Auto-hide header functionality
        let headerTimeout;
        let isHeaderVisible = true;

        function showHeader() {
            const header = document.querySelector('.header');
            const body = document.body;
            header.classList.remove('hidden');
            body.classList.remove('header-hidden');
            isHeaderVisible = true;
        }

        function hideHeader() {
            const header = document.querySelector('.header');
            const body = document.body;
            header.classList.add('hidden');
            body.classList.add('header-hidden');
            isHeaderVisible = false;
        }

        function resetHeaderTimer() {
            clearTimeout(headerTimeout);
            if (!isHeaderVisible) {
                showHeader();
            }
            headerTimeout = setTimeout(() => {
                hideHeader();
            }, 5000); // Hide after 5 seconds of inactivity
        }

        // Initialize the monitor system
        document.addEventListener('DOMContentLoaded', () => {
            new SupraMonitor();
            
            // Set up auto-hide header
            document.addEventListener('mousemove', resetHeaderTimer);
            document.addEventListener('keydown', resetHeaderTimer);
            document.addEventListener('click', resetHeaderTimer);
            
            // Start the timer
            resetHeaderTimer();
        });
    </script>
</body>
</html>